-   [Aims](#aims)
-   [Libraries](#libraries)
    -   [CRAN libraries](#cran-libraries)
    -   [Non-CRAN libraries](#non-cran-libraries)
        -   [Loading Non\_CRAN libraries and setting
            theme](#loading-non_cran-libraries-and-setting-theme)
    -   [Creating folders using
        “initProjectFolder()”](#creating-folders-using-initprojectfolder)
-   [Extracting kinfitresults](#extracting-kinfitresults)
-   [Tidying data.](#tidying-data.)
-   [New weights with
    kinfitr::weights\_create](#new-weights-with-kinfitrweights_create)
-   [Fitting and plotting MRTM1 multiple times for regions FC and
    WB](#fitting-and-plotting-mrtm1-multiple-times-for-regions-fc-and-wb)
-   [Fitting MRTM2 to each region of each
    individual](#fitting-mrtm2-to-each-region-of-each-individual)
    -   [Plotting fitted MRTM2 model](#plotting-fitted-mrtm2-model)
        -   [Plot MRTM2 tacs](#plot-mrtm2-tacs)
-   [new plot MRTM2](#new-plot-mrtm2)
-   [Fitting kintetic model srtm](#fitting-kintetic-model-srtm)
-   [Plotting Kinetic Model srtm](#plotting-kinetic-model-srtm)
-   [new plot srtm](#new-plot-srtm)
-   [plot logan\_tstar](#plot-logan_tstar)
    -   [All 4 tstar plots on a single
        page](#all-4-tstar-plots-on-a-single-page)
    -   [Plot refLogan](#plot-reflogan)
-   [Test-retest](#test-retest)
    -   [Making the trt\_table](#making-the-trt_table)
-   [Interregional Correlation](#interregional-correlation)
-   [bp corellation](#bp-corellation)
    -   [R-squared](#r-squared)

Aims
====

The aim of this assignment is to analyze the AZ10419369 data in kinfitr

Libraries
=========

CRAN libraries
--------------

First, the libraries for the analysis and plotting are loaded.

``` r
library(tidyverse)
library(stringr)
library(corrplot)
library(grid)
library(gridExtra)
library(RColorBrewer)
library(psych)
library(readxl)
library(pracma)
library(lme4)
library(rjags)
library(knitr)
library(cowplot)
library(corrplot)
library(viridis)
library(epitrix)
```

Non-CRAN libraries
------------------

The libraries above can be installed from CRAN. Those which cannot are
installed as follows:

``` r
install.packages("devtools")  # If you do not already have devtools
devtools::install_github("mathesong/kinfitr")
devtools::install_github("mathesong/granviller")
devtools::install_github("mvuorre/vmisc")
devtools::install_github("mathesong/kipettools")
devtools::install_github("mathesong/relfeas")
```

### Loading Non\_CRAN libraries and setting theme

``` r
library(kinfitr)
# library(vmisc)
library(kipettools)
library(granviller)
library(relfeas)

theme_set(theme_light())
```

Creating folders using “initProjectFolder()”
--------------------------------------------

``` r
initProjectFolder()
```

Extracting kinfitresults
========================

``` r
 tactibble <- tibble(Filename = list.files(path = "../RawData/", 
                                           pattern = "kinfitresults.mat")) %>% 
  group_by(Filename) %>% 
  mutate(tacdata = map(Filename, ~kipettools::kfresults_getData(
    paste0("../RawData/", .x))))

saveRDS(tactibble, '../DerivedData/tactibble.rds')
```

Tidying data.
=============

``` r
#loading data

tacs <- readRDS('../DerivedData/tactibble.rds')

tacs <- tacs %>% 
  ungroup() %>% 
  mutate(Subjname = map_chr(tacdata, "Subjname"),
         PETNo = map_dbl(tacdata, "PETNo"),
         tacdata = map(tacdata, "tacdata")) %>% 
  select(-Filename) 
```

New weights with kinfitr::weights\_create
=========================================

``` r
#Creating start and end times and 
#removing the old weights, so that there is no mix-up later on

tacs <- tacs %>% 
  unnest() %>% 
  mutate("start" = times - (durations/2)) %>% 
  mutate("end" = times + (durations/2)) %>% 
  select(-weights)
```

    ## Warning: `cols` is now required.
    ## Please use `cols = c(tacdata)`

``` r
# New weights

tacs$weights <- weights_create(t_start = tacs$start, t_end = tacs$end, 
                               tac = tacs$WB, radioisotope = "C11")
#Nest

tacs <- tacs %>%
  nest(-Subjname, -PETNo, .key = 'tacdata')
```

    ## Warning: All elements of `...` must be named.
    ## Did you want `tacdata = c(L_WM, R_WM, WM, GM, WB, L_MB, R_MB, MB, gmL_AST_gm, gmR_AST_gm, 
    ##     gmAST_gm, gmL_STR_gm, gmR_STR_gm, gmSTR_gm, gmVST_m_gm, gmpostPU_m_gm, 
    ##     L_AST, R_AST, AST, L_STR, R_STR, STR, VST_m, postPU_m, gmL_CBL, 
    ##     gmR_CBL, gmCBL, gmL_VST, gmR_VST, gmVST, gmL_postCA, gmR_postCA, 
    ##     gmpostCA, gmL_postPU, gmR_postPU, gmpostPU, gmL_preCA, gmR_preCA, 
    ##     gmpreCA, gmL_prePU, gmR_prePU, gmprePU, L_abc, R_abc, abc, 
    ##     help2, help3, L_FSLSFC, R_FSLSFC, FSLSFC, L_FSLSOC, R_FSLSOC, 
    ##     FSLSOC, L_FSLSPC, R_FSLSPC, FSLSPC, L_FSLSTC, R_FSLSTC, FSLSTC, 
    ##     L_FSLSLL, R_FSLSLL, FSLSLL, L_FSLSSTR, R_FSLSSTR, FSLSSTR, 
    ##     L_FSLSACC, R_FSLSACC, FSLSACC, L_FSLSAMG, R_FSLSAMG, FSLSAMG, 
    ##     FSLSBS, L_FSLSCAU, R_FSLSCAU, FSLSCAU, L_FSLSCER, R_FSLSCER, 
    ##     FSLSCER, L_FSLSCERCX, R_FSLSCERCX, FSLSCERCX, L_FSLSHIP, 
    ##     R_FSLSHIP, FSLSHIP, L_FSLSINS, R_FSLSINS, FSLSINS, L_FSLSLFC, 
    ##     R_FSLSLFC, FSLSLFC, L_FSLSLOC, R_FSLSLOC, FSLSLOC, L_FSLSLPC, 
    ##     R_FSLSLPC, FSLSLPC, L_FSLSLTC, R_FSLSLTC, FSLSLTC, L_FSLSMFC, 
    ##     R_FSLSMFC, FSLSMFC, L_FSLSMOC, R_FSLSMOC, FSLSMOC, L_FSLSMPC, 
    ##     R_FSLSMPC, FSLSMPC, L_FSLSMTC, R_FSLSMTC, FSLSMTC, L_FSLSOFC, 
    ##     R_FSLSOFC, FSLSOFC, L_FSLSPAL, R_FSLSPAL, FSLSPAL, L_FSLSPCC, 
    ##     R_FSLSPCC, FSLSPCC, L_FSLSPHIP, R_FSLSPHIP, FSLSPHIP, L_FSLSPUT, 
    ##     R_FSLSPUT, FSLSPUT, L_FSLSSMC, R_FSLSSMC, FSLSSMC, L_FSLSSN, 
    ##     R_FSLSSN, FSLSSN, L_FSLSTHA, R_FSLSTHA, FSLSTHA, L_FSLSVDC, 
    ##     R_FSLSVDC, FSLSVDC, `L_fsldctx-parstriangularis`, `R_fsldctx-parstriangularis`, 
    ##     `fsldctx-parstriangularis`, `L_fsldctx-rostralmiddlefrontal`, 
    ##     `R_fsldctx-rostralmiddlefrontal`, `fsldctx-rostralmiddlefrontal`, 
    ##     `L_fsldctx-caudalmiddlefrontal`, `R_fsldctx-caudalmiddlefrontal`, 
    ##     `fsldctx-caudalmiddlefrontal`, `L_fsldctx-frontalpole`, `R_fsldctx-frontalpole`, 
    ##     `fsldctx-frontalpole`, `L_fsldctx-medialorbitofrontal`, `R_fsldctx-medialorbitofrontal`, 
    ##     `fsldctx-medialorbitofrontal`, `L_fsldctx-superiorfrontal`, 
    ##     `R_fsldctx-superiorfrontal`, `fsldctx-superiorfrontal`, `L_fsldctx-lateralorbitofrontal`, 
    ##     `R_fsldctx-lateralorbitofrontal`, `fsldctx-lateralorbitofrontal`, 
    ##     `L_fsldctx-parsorbitalis`, `R_fsldctx-parsorbitalis`, `fsldctx-parsorbitalis`, 
    ##     `L_fsldctx-lateraloccipital`, `R_fsldctx-lateraloccipital`, 
    ##     `fsldctx-lateraloccipital`, `L_fsldctx-cuneus`, `R_fsldctx-cuneus`, 
    ##     `fsldctx-cuneus`, `L_fsldctx-lingual`, `R_fsldctx-lingual`, 
    ##     `fsldctx-lingual`, `L_fsldctx-pericalcarine`, `R_fsldctx-pericalcarine`, 
    ##     `fsldctx-pericalcarine`, `L_fsldctx-inferiorparietal`, `R_fsldctx-inferiorparietal`, 
    ##     `fsldctx-inferiorparietal`, `L_fsldctx-superiorparietal`, 
    ##     `R_fsldctx-superiorparietal`, `fsldctx-superiorparietal`, 
    ##     `L_fsldctx-supramarginal`, `R_fsldctx-supramarginal`, `fsldctx-supramarginal`, 
    ##     `L_fsldctx-precuneus`, `R_fsldctx-precuneus`, `fsldctx-precuneus`, 
    ##     `L_fsldctx-inferiortemporal`, `R_fsldctx-inferiortemporal`, 
    ##     `fsldctx-inferiortemporal`, `L_fsldctx-middletemporal`, `R_fsldctx-middletemporal`, 
    ##     `fsldctx-middletemporal`, `L_fsldctx-superiortemporal`, `R_fsldctx-superiortemporal`, 
    ##     `fsldctx-superiortemporal`, `L_fsldctx-transversetemporal`, 
    ##     `R_fsldctx-transversetemporal`, `fsldctx-transversetemporal`, 
    ##     `L_fsldctx-entorhinal`, `R_fsldctx-entorhinal`, `fsldctx-entorhinal`, 
    ##     `L_fsldctx-fusiform`, `R_fsldctx-fusiform`, `fsldctx-fusiform`, 
    ##     `L_fsldctx-temporalpole`, `R_fsldctx-temporalpole`, `fsldctx-temporalpole`, 
    ##     L_fsldAmygdala, R_fsldAmygdala, fsldAmygdala, `L_fsldAmygdala-Anterior`, 
    ##     `R_fsldAmygdala-Anterior`, `fsldAmygdala-Anterior`, L_fsldHippocampus, 
    ##     R_fsldHippocampus, fsldHippocampus, `L_fsldctx-parahippocampal`, 
    ##     `R_fsldctx-parahippocampal`, `fsldctx-parahippocampal`, `L_fsldctx-caudalanteriorcingulate`, 
    ##     `R_fsldctx-caudalanteriorcingulate`, `fsldctx-caudalanteriorcingulate`, 
    ##     `L_fsldctx-rostralanteriorcingulate`, `R_fsldctx-rostralanteriorcingulate`, 
    ##     `fsldctx-rostralanteriorcingulate`, `L_fsldctx-isthmuscingulate`, 
    ##     `R_fsldctx-isthmuscingulate`, `fsldctx-isthmuscingulate`, 
    ##     `L_fsldctx-posteriorcingulate`, `R_fsldctx-posteriorcingulate`, 
    ##     `fsldctx-posteriorcingulate`, L_fsldCaudate, R_fsldCaudate, 
    ##     fsldCaudate, `L_fsldAccumbens-area`, `R_fsldAccumbens-area`, 
    ##     `fsldAccumbens-area`, L_fsldPutamen, R_fsldPutamen, fsldPutamen, 
    ##     `L_fsldCerebellum-Cortex`, `R_fsldCerebellum-Cortex`, `fsldCerebellum-Cortex`, 
    ##     L_fsldInsula, R_fsldInsula, fsldInsula, `L_fsldctx-insula`, 
    ##     `R_fsldctx-insula`, `fsldctx-insula`, L_fsldPallidum, R_fsldPallidum, 
    ##     fsldPallidum, L_fsldOperculum, R_fsldOperculum, fsldOperculum, 
    ##     `L_fsldctx-paracentral`, `R_fsldctx-paracentral`, `fsldctx-paracentral`, 
    ##     `L_fsldctx-parsopercularis`, `R_fsldctx-parsopercularis`, 
    ##     `fsldctx-parsopercularis`, `L_fsldctx-postcentral`, `R_fsldctx-postcentral`, 
    ##     `fsldctx-postcentral`, `L_fsldctx-precentral`, `R_fsldctx-precentral`, 
    ##     `fsldctx-precentral`, L_fsldThalamus, R_fsldThalamus, fsldThalamus, 
    ##     `L_fsldThalamus-Proper`, `R_fsldThalamus-Proper`, `fsldThalamus-Proper`, 
    ##     L_fsldVentralDC, R_fsldVentralDC, fsldVentralDC, L_FSPVMPFC, 
    ##     R_FSPVMPFC, FSPVMPFC, L_FSPLPFC, R_FSPLPFC, FSPLPFC, L_FSPDLPFC, 
    ##     R_FSPDLPFC, FSPDLPFC, L_FSPMFC, R_FSPMFC, FSPMFC, L_FSPMOFC, 
    ##     R_FSPMOFC, FSPMOFC, L_FSPOFC, R_FSPOFC, FSPOFC, L_FSLSLFC2, 
    ##     R_FSLSLFC2, FSLSLFC2, L_FSG1ACORT, R_FSG1ACORT, FSG1ACORT, 
    ##     L_FSG1ASC, R_FSG1ASC, FSG1ASC, L_FSGTSC, R_FSGTSC, FSGTSC, 
    ##     L_FSGTCORT, R_FSGTCORT, FSGTCORT, L_FSGD1EXSTR, R_FSGD1EXSTR, 
    ##     FSGD1EXSTR, L_FSGD1CORT, R_FSGD1CORT, FSGD1CORT, times, durations, 
    ##     L_abc1, gmR_abc, help1, start, end, weights)`?

Fitting and plotting MRTM1 multiple times for regions FC and WB
===============================================================

``` r
#K2 prime for striatum to be used to MRTM2 later on

 tacs <- tacs %>% 
  group_by(Subjname, PETNo) %>% 
  mutate(MRTM1fit = map(tacdata, ~mrtm1(t_tac = .x$times, reftac = .x$gmCBL,
                                   roitac = .x$FSLSSTR, 
                                      weights = .x$weights,
                                   dur = .x$durations))) %>% 
  ungroup() %>% 
  mutate(bp_MRTM1 = map_dbl(MRTM1fit, c("par", "bp")),
         k2prime_MRTM1 = map_dbl(MRTM1fit, c("par", "k2prime"))) %>% 
  group_by(Subjname, PETNo) %>% 
  mutate(logan_tstar = map2(tacdata, k2prime_MRTM1,
                 ~refLogan_tstar(t_tac = .x$times, 
                    reftac = .x$gmCBL, lowroi = .x$FSLSFC, 
                    medroi = .x$FSLSINS, highroi = .x$FSLSSTR, 
                   k2prime = .y)))
```

Fitting MRTM2 to each region of each individual
===============================================

First, let’s select some specific regions. Note: I duplicated the CBL
region column into “CBL” and “Ref”. One of them is used to make the
reference tissue models when nested in tacdata whereas the other is used
for plotting in the new “all regions per PET +facet wrap by PET” - plot.
However, the srtm fitting gave me an error when I did this

``` r
regions <- c("STR" = "FSLSSTR", "FC" = "FSLSFC", "WB", "WM", "GM", "OC" = "FSLSOC", "insula" = "FSLSINS", "Putamen" = "FSLSPUT", "ACC" = "FSLSACC", "CBL" = "gmCBL",
             "THA" = "FSLSTHA", "TC" = "FSLSTC")
 
tacs <- tacs %>% 
  select(tacdata, Subjname, PETNo, k2prime_MRTM1, logan_tstar) %>% 
  mutate(tacdata = map(tacdata, ~select(.x, regions, times, weights, start))) 
```

    ## Note: Using an external vector in selections is ambiguous.
    ## i Use `all_of(regions)` instead of `regions` to silence this message.
    ## i See <https://tidyselect.r-lib.org/reference/faq-external-vector.html>.
    ## This message is displayed once per session.

``` r
#Long data. By gathering the regions into a single region collumn we can group_by region and then iterate over every region. note, do not select the reference region, as that should be included for every single region and not group_by seperately from the rest!

tacs_long <- tacs %>% 
  unnest(tacdata, .drop = FALSE) %>% 
  gather(key = Region, value = TAC, -times, -weights,
         -Subjname, -PETNo, -k2prime_MRTM1, -CBL, -logan_tstar, -start) %>% 
  group_by(Subjname, PETNo, Region, k2prime_MRTM1) %>% 
  nest(.key = "tacdata") %>% 
  mutate(PET = paste(Subjname, PETNo, sep='_')) 
```

    ## Warning: The `.drop` argument of `unnest()` is deprecated as of tidyr 1.0.0.
    ## All list-columns are now preserved.
    ## This warning is displayed once every 8 hours.
    ## Call `lifecycle::last_warnings()` to see where this warning was generated.

    ## Warning: `.key` is deprecated

``` r
# t* in minutes

 tstar <- tacs_long %>% 
  unnest(tacdata) %>% 
  group_by(PET, Subjname, PETNo, 
         Region) %>%
  select(PET, Subjname, PETNo, 
         Region, start) %>%
  mutate(n = row_number(), max_frame = max(n), start = start, 
          reflogan_tstar = 10) %>% 
   mutate(mrtm2_tstar = max_frame, 
          reflogan_tstar = max_frame-reflogan_tstar) %>% 
  filter(n == mrtm2_tstar | n == reflogan_tstar) %>% 
  filter(Region %in% c("STR", "FC")) %>% 
  mutate(Model = ifelse(n == reflogan_tstar, "ref Logan", "MRTM2")) %>%
  ungroup() %>% 
  arrange(PET, Subjname, PETNo) %>% 
  slice(5:8) %>% 
  select(-c(PET:PETNo), -c(n:reflogan_tstar), - mrtm2_tstar) %>% 
  spread(key = Model, value = start) %>% 
  mutate(Ligand = "SCH23390") %>% 
  select(Ligand, everything()) %>% 
  slice(1) %>% 
  select(-Region)
  
# tstar %>%
#   saveRDS(., "sch_tstar_kinfitr.rds")

#Fitting MRTM2 using the K2_prime values obtained for the striatum through the MRTM1 fitting earlier. note Map2 iterates over 2 columns tacdata and k2prime_MRTM1, where .x refers to tacdata and .y refers to k2prime_MRTM1.

tacs_long <- tacs_long %>% 
  group_by(Subjname, PETNo, Region) %>% 
  mutate(MRTM2fit = map2(tacdata, k2prime_MRTM1,
                         ~mrtm2(t_tac=.x$times, reftac = .x$CBL, 
                               roitac = .x$TAC, k2prime = .y, 
                               weights = .x$weights,
                               dur = .x$durations)),
         bp_MRTM2 = map_dbl(MRTM2fit, c("par", "bp"))) 
```

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

    ## Warning: Unknown or uninitialised column: `durations`.

Plotting fitted MRTM2 model
---------------------------

And now, let’s take a look at the BP<sub>ND</sub> values. We’ll want to
divide them by ROI I think.

``` r
ggplot(tacs_long, aes(x=bp_MRTM2, fill=Region)) +
  geom_histogram(colour="black") +
  facet_wrap(~Region, scales="free") +
  guides(fill=FALSE)
```

### Plot MRTM2 tacs

Labels for regions are wrong. My intention is to have one plot per
region for each PET in the same grid. Currently, all labels for the
regions are the same for each individual.

``` r
mrtm2_fits = map2(tacs_long$MRTM2fit, tacs_long$Region, 
                    ~plot_kinfit(.x, roiname=.y))
 
PETs <- unique(tacs_long$PET)
 
allFits <- data.frame(PET = rep(PETs, each= 9)) %>%
 mutate(Fit = mrtm2_fits,
          Plot = 'Fit',
          PET = as.character(PET)) %>%
   arrange(PET, Plot)
 
 marrangeGrob(allFits$Fit, nrow=3, ncol=3, top=quote(paste('PET: ', PETs[g])))
```

new plot MRTM2
==============

``` r
MRTM2 <- tacs_long %>% 
  group_by(PET, Region) %>% 
  mutate(mrtm2fits = map(MRTM2fit, c("tacs"))) %>% 
   select(PET, Region, mrtm2fits) %>% 
  filter(Region %in% c('FC', 'WB', 'insula', 'OC')) %>% 
  unnest()
```

    ## Warning: `cols` is now required.
    ## Please use `cols = c(mrtm2fits)`

``` r
ggplot() +
  geom_point(data = MRTM2, aes(x=Time, y=Target, color = Region)) + geom_line(data = MRTM2, aes(x = Time, y=Target, color = Region)) + geom_point(data = MRTM2, aes(x=Time, y=Reference, color = "Ref")) + geom_line(data = MRTM2, aes(x=Time, y=Reference, color = "Ref")) +
  facet_wrap(~ PET , ncol=2)
```

![](SCH23390_files/figure-markdown_github/new_plot_MRTM2-1.png)

Fitting kintetic model srtm
===========================

``` r
tacs_long <- tacs_long %>% 
  group_by(Subjname, PETNo, Region) %>%
  mutate(srtmfit = map(tacdata, ~srtm(t_tac = .x$times, reftac = .x$CBL,      
                                      roitac = .x$TAC, weights = .x$weights))) %>% 
  mutate(bp_srtm = map_dbl(srtmfit, c('par', 'bp')))
```

    ## Registered S3 methods overwritten by 'car':
    ##   method                          from
    ##   influence.merMod                lme4
    ##   cooks.distance.influence.merMod lme4
    ##   dfbeta.influence.merMod         lme4
    ##   dfbetas.influence.merMod        lme4

Plotting Kinetic Model srtm
===========================

Note: Labels are not quite at the same location for each PET, still
unsolved.

``` r
srtm_plot <-tacs_long %>% 
 group_by(PET, Region) %>% 
  mutate(srtm_graph = map2(srtmfit, Region, 
      ~ plot_kinfit(.x, roiname = .y))) %>% 
  ungroup() %>% 
  filter(Region %in% c('FC', 'WB', 'ACC', 'CBL')) %>% 
  filter(Subjname %in% c("anek",  "bjsi",  "hagex","sith",  "teju",
                         "msjn",  "nohe", "rosj")) %>% 
  select(PET, srtm_graph) %>%
  group_by(PET) %>% 
  arrange(PET)
  

walk2(list(srtm_plot$srtm_graph), unique(srtm_plot$PET), 
    ~print(plot_grid( plotlist = .x, ncol = 2, nrow = 2, align = 'hv') +
  draw_plot_label( label = .y , y = 1, x = 0.5, fontface = "bold", size = 20, colour = "red", hjust = 1, vjust = 1.2)))
```

![](SCH23390_files/figure-markdown_github/plot_srtm-1.png)![](SCH23390_files/figure-markdown_github/plot_srtm-2.png)![](SCH23390_files/figure-markdown_github/plot_srtm-3.png)![](SCH23390_files/figure-markdown_github/plot_srtm-4.png)![](SCH23390_files/figure-markdown_github/plot_srtm-5.png)![](SCH23390_files/figure-markdown_github/plot_srtm-6.png)![](SCH23390_files/figure-markdown_github/plot_srtm-7.png)![](SCH23390_files/figure-markdown_github/plot_srtm-8.png)![](SCH23390_files/figure-markdown_github/plot_srtm-9.png)![](SCH23390_files/figure-markdown_github/plot_srtm-10.png)![](SCH23390_files/figure-markdown_github/plot_srtm-11.png)![](SCH23390_files/figure-markdown_github/plot_srtm-12.png)![](SCH23390_files/figure-markdown_github/plot_srtm-13.png)![](SCH23390_files/figure-markdown_github/plot_srtm-14.png)![](SCH23390_files/figure-markdown_github/plot_srtm-15.png)![](SCH23390_files/figure-markdown_github/plot_srtm-16.png)

new plot srtm
=============

``` r
Srtm <- tacs_long %>% 
  group_by(PET, Region) %>% 
  mutate(srtmtacs = map(srtmfit, c("tacs"))) %>% 
   select(PET, Region, srtmtacs) %>% 
  filter(Region %in% c('FC', 'WB', 'insula', 'OC')) %>% 
  unnest()
         
ggplot() +
  geom_point(data = Srtm, aes(x=Time, y=Target, color = Region)) + geom_line(data = Srtm, aes(x = Time, y=Target_fitted, color = Region)) + geom_point(data = Srtm, aes(x=Time, y=Reference, color = "Ref")) + geom_line(data = Srtm, aes(x=Time, y=Reference, color = "Ref")) +
  facet_wrap(~ PET , ncol=2)
```

plot logan\_tstar
=================

Trouble with label, it is at the same level as the medium, high and low
ROI labels. Tried moving label with vjust = 0.5. It works, sort of. the
label moves up, half of it dissapears and part of the plots at the
bottom dissapear. Solution?? Addition: in the end I did manage to get
the label up a bit without harming the graph, vjust = 0.97 was the
lowest vjust value I could make. I temporarilly changed the color of the
label to distinguish easier. Looks a little unprofessional, though. I
tried with draw\_labels or draw-figure\_labels and didn’t see any
improvement. Also, I tried getting all the subjects into the same pane
by making ncol = 2 and nrow = 3 or making sample\_n(size = 4) and ncol
and nrow = 2. It just got really messy. Also, initially I thought I
could skip “print”, but that is not possible. you get no error without
print, but no graphs either. I thought I got no graph because of eval =
FALSE, but that was an incorrect assumption.

``` r
set.seed(123)

tstar_fits <- tacs_long %>%  
  ungroup() %>% 
  select(tacdata, PET) %>% 
  unnest() %>% 
  select(PET, logan_tstar) %>% 
  sample_n(size =  4, replace = F) 


walk2(list(tstar_fits$logan_tstar), tstar_fits$PET, 
    ~print(plot_grid(plotlist = .x, ncol = 1, nrow = 1, labels = paste('PET:',.y), label_x = 0.5, label_y = 1, label_colour = "blue", vjust = 0.97)))
```

All 4 tstar plots on a single page
----------------------------------

Note: I would like to have the “draw\_figure\_label” be drawn a bit
above the first PET, but that does not seem to be happening. Should I
just skip it? I Placed the plots in a single column because it was a
little hard distinguishing where one ands and another begins in a 2 x 2
format. Perhaps one could put borders and then the 2 x 2 would work
better?

``` r
plot_grid(plotlist = tstar_fits$logan_tstar, ncol = 1, nrow = 4, labels = paste('PET:',tstar_fits$PET), label_x = 0.5, label_y = 1, label_colour = "blue", vjust = 0.97) #+
  #draw_figure_label("t*", position = "top", fontface = "bold", size = 32, colour = "red")
```

\#Fitting and plotting Kinetic Model refLogan

``` r
tacs_long <- tacs_long %>% 
   group_by(PET, Subjname, PETNo, Region) %>% 
  mutate(loganfit = map2(tacdata, k2prime_MRTM1,
          ~refLogan(t_tac = .x$times , reftac = .x$CBL, roitac = .x$TAC, tstarIncludedFrames = 10, k2prime = .y, dur = .x$durations ))) %>% 
     mutate(bp_refLogan = map_dbl(loganfit, c("par", "bp"))) %>%  
  ungroup()
```

Plot refLogan
-------------

``` r
logan_plot <-tacs_long %>% 
 group_by(PET, Region) %>% 
  mutate(logan_graph = map2(loganfit, Region, 
      ~ plot(.x, roiname = .y))) %>% 
  ungroup() %>% 
  filter(Region %in% c('FC', 'WB', 'STR', 'OC')) %>% 
  filter(Subjname %in% c("anek",  "bjsi",  "hagex","sith",  "teju",
                         "msjn",  "nohe", "rosj")) %>% 
  select(PET, logan_graph) %>%
  group_by(PET) %>% 
  arrange(PET)
  

walk2(list(logan_plot$logan_graph), unique(logan_plot$PET), 
    ~print(plot_grid( plotlist = .x, ncol = 2, nrow = 2) +
  draw_plot_label( label = .y , y = 1, x = 0.5, fontface = "bold", size = 20, colour = "red", hjust = 1, vjust = 1.2)))
```

Test-retest
===========

``` r
trt_check <- tacs_long %>%
  select(Subjname, PETNo, Region, bp_MRTM2, bp_srtm, bp_refLogan) %>% 
  gather(Measure, Value, -Subjname, -PETNo, -Region) %>% 
  group_by(Region, Measure) %>% 
  nest(.key = "data") 
```

    ## Warning: `.key` is deprecated

``` r
saveRDS(tacs_long,'../DerivedData/raw_kinfit_SCH23390.rds')
```

### Making the trt\_table

``` r
trt_check <- trt_check %>% 
  group_by(Region, Measure) %>% 
  mutate(trt = map(data, ~relfeas::trt(.x, 
                                       values = "Value", 
                                       cases = "Subjname")),
         trt_tidy = map(trt, c("tidy")))

trt_table <- select(trt_check, trt_tidy) %>% 
  unnest()

kable(trt_table, digits=3)
```

| Region  | Measure      |    mean|     sd|      cv|    skew|  kurtosis|    icc|  icc\_l|  icc\_u|    wscv|    sdd|  absvar|  signvar|  signvar\_sd|
|:--------|:-------------|-------:|------:|-------:|-------:|---------:|------:|-------:|-------:|-------:|------:|-------:|--------:|------------:|
| STR     | bp\_MRTM2    |   1.476|  0.164|   0.111|  -0.308|    -0.610|  0.829|   0.631|   0.927|   0.047|  0.190|   0.049|   -0.004|        0.068|
| FC      | bp\_MRTM2    |   0.272|  0.047|   0.173|   0.183|    -0.355|  0.581|   0.217|   0.806|   0.113|  0.085|   0.130|   -0.035|        0.161|
| WB      | bp\_MRTM2    |   0.193|  0.038|   0.198|   0.242|    -0.467|  0.493|   0.096|   0.758|   0.142|  0.076|   0.168|   -0.041|        0.204|
| WM      | bp\_MRTM2    |  -0.111|  0.051|  -0.457|   0.406|    -1.306|  0.864|   0.700|   0.943|  -0.171|  0.053|  -0.273|   -0.043|        0.246|
| GM      | bp\_MRTM2    |   0.251|  0.040|   0.159|   0.206|    -0.217|  0.451|   0.041|   0.734|   0.119|  0.083|   0.137|   -0.039|        0.169|
| OC      | bp\_MRTM2    |   0.267|  0.061|   0.228|   0.062|    -0.731|  0.534|   0.165|   0.778|   0.159|  0.117|   0.167|   -0.084|        0.215|
| insula  | bp\_MRTM2    |   0.488|  0.053|   0.108|  -0.002|    -1.204|  0.294|  -0.142|   0.638|   0.091|  0.123|   0.102|   -0.018|        0.132|
| Putamen | bp\_MRTM2    |   1.579|  0.136|   0.086|  -0.326|     0.025|  0.785|   0.547|   0.907|   0.040|  0.177|   0.049|   -0.003|        0.059|
| ACC     | bp\_MRTM2    |   0.456|  0.052|   0.113|   0.214|    -1.095|  0.263|  -0.176|   0.618|   0.097|  0.123|   0.111|    0.024|        0.140|
| THA     | bp\_MRTM2    |   0.073|  0.062|   0.856|   0.091|    -0.281|  0.490|   0.092|   0.756|   0.617|  0.124|  -4.240|    0.058|        0.901|
| TC      | bp\_MRTM2    |   0.360|  0.054|   0.151|   0.142|    -0.569|  0.563|   0.200|   0.794|   0.101|  0.101|   0.118|   -0.048|        0.139|
| STR     | bp\_srtm     |   1.492|  0.166|   0.111|  -0.313|    -0.601|  0.830|   0.632|   0.927|   0.046|  0.192|   0.050|   -0.002|        0.068|
| FC      | bp\_srtm     |   0.289|  0.050|   0.174|   0.583|     0.464|  0.510|   0.118|   0.767|   0.123|  0.098|   0.137|   -0.029|        0.177|
| WB      | bp\_srtm     |   0.234|  0.043|   0.183|   0.664|     0.546|  0.371|  -0.056|   0.686|   0.146|  0.095|   0.167|   -0.033|        0.211|
| WM      | bp\_srtm     |  -0.022|  0.054|  -2.495|   0.357|    -0.391|  0.611|   0.261|   0.821|  -1.573|  0.094|   1.895|   -0.056|        2.302|
| GM      | bp\_srtm     |   0.283|  0.045|   0.158|   0.728|     1.167|  0.349|  -0.082|   0.673|   0.128|  0.101|   0.144|   -0.034|        0.184|
| OC      | bp\_srtm     |   0.295|  0.063|   0.215|   0.657|     0.832|  0.429|   0.030|   0.718|   0.165|  0.135|   0.149|   -0.080|        0.227|
| insula  | bp\_srtm     |   0.525|  0.055|   0.105|   0.021|    -1.104|  0.201|  -0.240|   0.576|   0.094|  0.136|   0.103|   -0.021|        0.135|
| Putamen | bp\_srtm     |   1.593|  0.137|   0.086|  -0.285|     0.055|  0.780|   0.538|   0.904|   0.041|  0.181|   0.049|   -0.003|        0.060|
| ACC     | bp\_srtm     |   0.486|  0.054|   0.111|   0.394|    -0.721|  0.253|  -0.187|   0.611|   0.096|  0.130|   0.110|    0.033|        0.137|
| THA     | bp\_srtm     |   0.087|  0.063|   0.726|  -0.031|    -0.228|  0.392|  -0.031|   0.699|   0.570|  0.138|   1.244|    0.095|        0.828|
| TC      | bp\_srtm     |   0.384|  0.056|   0.147|   0.446|    -0.006|  0.417|   0.012|   0.712|   0.114|  0.121|   0.127|   -0.051|        0.157|
| STR     | bp\_refLogan |   1.478|  0.167|   0.113|  -0.372|    -0.603|  0.824|   0.621|   0.925|   0.048|  0.197|   0.053|   -0.004|        0.070|
| FC      | bp\_refLogan |   0.279|  0.048|   0.172|   0.330|    -0.052|  0.551|   0.174|   0.790|   0.116|  0.090|   0.131|   -0.033|        0.167|
| WB      | bp\_refLogan |   0.210|  0.039|   0.186|   0.389|    -0.078|  0.447|   0.036|   0.732|   0.140|  0.082|   0.162|   -0.037|        0.201|
| WM      | bp\_refLogan |  -0.087|  0.050|  -0.576|   0.381|    -1.246|  0.861|   0.693|   0.941|  -0.218|  0.052|  -0.052|   -0.061|        0.313|
| GM      | bp\_refLogan |   0.265|  0.041|   0.156|   0.380|     0.240|  0.417|  -0.001|   0.714|   0.120|  0.088|   0.137|   -0.036|        0.171|
| OC      | bp\_refLogan |   0.279|  0.061|   0.219|   0.241|    -0.390|  0.515|   0.140|   0.768|   0.155|  0.120|   0.162|   -0.079|        0.212|
| insula  | bp\_refLogan |   0.501|  0.053|   0.107|  -0.030|    -1.182|  0.242|  -0.197|   0.604|   0.093|  0.129|   0.103|   -0.021|        0.135|
| Putamen | bp\_refLogan |   1.579|  0.138|   0.087|  -0.368|    -0.006|  0.782|   0.543|   0.905|   0.041|  0.181|   0.049|   -0.003|        0.060|
| ACC     | bp\_refLogan |   0.467|  0.052|   0.111|   0.284|    -0.895|  0.234|  -0.206|   0.598|   0.098|  0.127|   0.109|    0.029|        0.140|
| THA     | bp\_refLogan |   0.078|  0.062|   0.795|   0.081|    -0.245|  0.455|   0.047|   0.736|   0.592|  0.129|   2.229|    0.076|        0.863|
| TC      | bp\_refLogan |   0.370|  0.055|   0.149|   0.249|    -0.340|  0.508|   0.126|   0.765|   0.106|  0.109|   0.122|   -0.048|        0.147|

Interregional Correlation
=========================

Here the interregional correlations BP are assessed

``` r
bp_srtm <- tacs_long %>%
  select(PET, Region, bp_srtm) %>%
  spread(Region, bp_srtm)

bp_mrtm2 <- tacs_long %>%
  select(PET, Region, bp_MRTM2) %>%
  spread(Region, bp_MRTM2)

bp_logan <- tacs_long %>%
  select(PET, Region, bp_refLogan) %>%
  spread(Region, bp_refLogan)

col2 <- colorRampPalette(rev(c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7",
                           "#FFFFFF", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")))

par(mfrow=c(2,2))

bp_srtm %>%
  select(FC:WM, - Putamen) %>%
  cor() %>%
  corrplot.mixed(lower='ellipse', upper='number', 
                 lower.col = col2(200), upper.col = col2(200),  diag='n',
                 number.digits = 2, title=expression(bp_srtm ~ Correlations),
                 mar=c(0,0,1,0))

bp_logan %>%
  select(FC:WM, - Putamen) %>%
  cor() %>%
  corrplot.mixed(lower='ellipse', upper='number', 
                 lower.col = col2(200), upper.col = col2(200),  diag='n',
                 number.digits = 2, title=expression(bp_logan ~ Correlations),
                 mar=c(0,0,1,0))

bp_mrtm2 %>%
  select(FC:WM, - Putamen) %>%
  cor() %>%
  corrplot.mixed(lower='ellipse', upper='number', 
                 lower.col = col2(200), upper.col = col2(200),  diag='n',
                 number.digits = 2, title=expression(bp_MRTM2 ~ Correlations),
                 mar=c(0,0,1,0))
```

![](SCH23390_files/figure-markdown_github/corrplots-1.png)

\#Corrplot between measures for a single region

``` r
compare <- tacs_long %>% 
  select(PET, Region, bp_srtm, bp_refLogan ,bp_MRTM2 ) %>% 
  filter(Region %in% c('FC', 'WB', 'insula', 'OC'))

par(mfrow=c(2,2))

compare %>%
  filter(Region == "FC") %>%
  select(bp_srtm:bp_MRTM2) %>% 
  cor() %>%
  corrplot.mixed(lower='ellipse', upper='number', 
                 lower.col = col2(200), upper.col = col2(200),  diag='n',
                 number.digits = 2, title=expression(Model ~ Correlations ~ Region: FC),
                 mar=c(0,0,1,0)) 

compare %>%
  filter(Region == "OC") %>%
  select(bp_srtm:bp_MRTM2) %>% 
  cor() %>%
  corrplot.mixed(lower='ellipse', upper='number', 
                 lower.col = col2(200), upper.col = col2(200),  diag='n',
                 number.digits = 2, title=expression(Model ~ Correlations ~ Region: OC),
                 mar=c(0,0,1,0))  

compare %>%
  filter(Region == "insula") %>%
  select(bp_srtm:bp_MRTM2) %>% 
  cor() %>%
  corrplot.mixed(lower='ellipse', upper='number', 
                 lower.col = col2(200), upper.col = col2(200),  diag='n',
                 number.digits = 2, title=expression(Model ~ Correlations ~ Region: insula),
                 mar=c(0,0,1,0))  

compare %>%
  filter(Region == "WB") %>%
  select(bp_srtm:bp_MRTM2) %>% 
  cor() %>%
  corrplot.mixed(lower='ellipse', upper='number', 
                 lower.col = col2(200), upper.col = col2(200),  diag='n',
                 number.digits = 2, title=expression(Model ~ Correlations ~ Region: WB),
                 mar=c(0,0,1,0)) 
```

![](SCH23390_files/figure-markdown_github/corrplot-1.png)

bp corellation
==============

R-squared
---------

``` r
trtdata <- tacs_long %>%
  select(PET, Subjname, PETNo, Region, bp_refLogan, bp_srtm, bp_MRTM2) %>%
  gather(Measure, Value, -(PET:Region)) %>%
  spread(Region, Value)

trtdata <- trtdata %>%
  select( -(c(STR, OC, insula))) %>%
  gather(Region, Value, -(PET:Measure)) %>%
  unite(Outcome, Measure, Region) %>%
  spread(Outcome, Value)

corout <- trtdata %>%
  gather(Measure, Binding, -(PET:PETNo), -bp_srtm_WB) %>%
  group_by(Measure) %>%
  summarise('R^2^'=cor(Binding, bp_srtm_WB)^2) %>%
  arrange(Measure) %>%
  ungroup() %>%
  mutate(Measure = str_replace(string=Measure, pattern='_', replacement='~')) %>%
  mutate(Measure = str_replace(string=Measure, pattern='FC', replacement='FC~')) %>%
  mutate(Measure = str_replace(string=Measure, pattern='WB', replacement='WB~')) %>%
  mutate(Measure = str_replace(string=Measure, pattern='OC', replacement='OC~')) %>% 
  mutate(Measure = str_replace(string=Measure, pattern='WM', replacement='WM~')) %>% 
  mutate(Measure = str_replace(string=Measure, pattern='GM', replacement='GM~')) %>% 
  mutate(Measure = str_replace(string=Measure, pattern='STR', replacement='STR~')) 

kable(corout, digits=2, caption="Correlations with BP_srtm~WB~")
```

| Measure                   |  R<sup>2</sup>|
|:--------------------------|--------------:|
| bp\~MRTM2\_ACC            |           0.46|
| bp<sub>MRTM2\_FC</sub>    |           0.78|
| bp<sub>MRTM2\_GM</sub>    |           0.86|
| bp\~MRTM2\_Putamen        |           0.48|
| bp\~MRTM2\_TC             |           0.76|
| bp\~MRTM2\_THA            |           0.26|
| bp<sub>MRTM2\_WB</sub>    |           0.94|
| bp<sub>MRTM2\_WM</sub>    |           0.69|
| bp\~refLogan\_ACC         |           0.49|
| bp<sub>refLogan\_FC</sub> |           0.82|
| bp<sub>refLogan\_GM</sub> |           0.90|
| bp\~refLogan\_Putamen     |           0.48|
| bp\~refLogan\_TC          |           0.78|
| bp\~refLogan\_THA         |           0.29|
| bp<sub>refLogan\_WB</sub> |           0.96|
| bp<sub>refLogan\_WM</sub> |           0.67|
| bp\~srtm\_ACC             |           0.52|
| bp<sub>srtm\_FC</sub>     |           0.86|
| bp<sub>srtm\_GM</sub>     |           0.95|
| bp\~srtm\_Putamen         |           0.48|
| bp\~srtm\_TC              |           0.80|
| bp\~srtm\_THA             |           0.31|
| bp<sub>srtm\_WM</sub>     |           0.49|

\#Plot of the change between PETNo = 1 and PETNo = 2. error bars for the
wscv probably mean nothing as there is just a single value, but looks
nice?

``` r
trtdata <- trtdata %>% 
  gather(Region, Value, -(PET:PETNo)) %>% 
  separate(col = "Region", into = c("outcome","Measure", "Region"), sep = '_') %>% 
  unite(outcome, outcome, Measure, sep = '_') %>% 
  ungroup()

trtsrtm <- trtdata %>% 
  filter(outcome == 'bp_srtm')

ggplot(trtsrtm, aes(x = PETNo, y = Value, 
                         group = Region, colour=Region)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  facet_wrap( ~ Subjname, ncol = 4)
```

    ## `geom_smooth()` using formula 'y ~ x'

![](SCH23390_files/figure-markdown_github/unnamed-chunk-3-1.png)
