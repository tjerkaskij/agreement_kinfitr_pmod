---
title: "PMOD_reformat_PK11195"
author: "Jonathan Tjerkaski"
date: "14 June 2019"
output: 
  pdf_document:
    toc: yes
    toc_depth: 3
  md_document:
    toc: yes
    toc_depth: 3
    variant: markdown_github
---

#Packages

First, the libraries for the analysis and plotting are loaded.

```{r cran_packages, message=FALSE, warning =FALSE}
library(tidyverse)
library(stringr)
library(corrplot)
library(grid)
library(gridExtra)
library(RColorBrewer)
library(psych)
library(readxl)
library(pracma)
library(lme4)
library(rjags)
library(knitr)
library(cowplot)
library(corrplot)
library(viridis)
```

### Loading Non_CRAN libraries and setting theme

```{r load_github_package}

library(kinfitr)
library(vmisc)
library(kipettools)
library(granviller)
library(relfeas)

theme_set(theme_light())

```

# Extracting roistats and Tidying data. 

```{r Tidying_data}

#Extracting tac data

tacs <- tibble(Filename = list.files(path = "../RawData/", 
                                          pattern = "roistats.mat")) %>% 
   group_by(Filename) %>% 
   mutate(tacdata = map(Filename, ~kipettools::roistats_getData(
     paste0("../RawData/", .x))))

tacs <- tacs %>% 
  ungroup() %>% 
  mutate(Subjname = map_chr(tacdata, "Subjname"),
         PETNo = map_dbl(tacdata, "PETNo"),
         tacdata = map(tacdata, "tacdata")) %>% 
  select(-Filename) %>% 
  mutate(PET = paste(Subjname, PETNo, sep='_')) 

#loading weights and blood data
oldwd <- getwd()

setwd("../RawData/")

blood <- list()
bloodfiles <- list.files(pattern='blood_processed_pfhill')

for(i in 1:length(bloodfiles)) {
blood[[bloodfiles[i]]] <- read_tsv(bloodfiles[i])
   print(paste0('Progress: ', i, ' / ', length(bloodfiles)))
 }

blood <- tibble(blood)

Weights_list <- list()
weightfiles <- list.files(pattern='_weights2009')

for(i in 1:length(weightfiles)) {
Weights_list[[weightfiles[i]]] <- read_csv(weightfiles[i], col_names = FALSE)
   print(paste0('Progress: ', i, ' / ', length(weightfiles)))
 }


setwd(oldwd)


Weights_list <- tibble(Weights_list)

Weights_list$PET <- weightfiles %>%  
str_replace("_weights2009.txt", " ") 


Weights_list <- Weights_list %>% 
group_by(PET) %>% 
unnest() %>% 
rename(weights = X1) %>% 
ungroup()

tacs <- tacs %>% 
unnest() %>%  
select(Subjname:PET, WM, GM, WB, FC, OC, THA, STR, ACC, CBL = CER, INS, TC, times, durations) %>% add_column(weights = Weights_list$weights) %>%  
rename("Times" = times) %>% 
group_by(PET, Subjname, PETNo) %>% 
nest(.key = tacdata) %>% 
ungroup()


blood$PET. <- bloodfiles %>%  
str_replace("_blood_processed_pfhill.txt", " ") 

blood  <- blood %>% 
  unnest() %>% 
 rename(Cbl.disp.corr = "Cbl disp corr", Cpl = "Cpl (nCi/cc)", ABSS.sec = "ABSS sec" ) %>% 
  mutate(Cbl.disp.corr = ifelse(Cbl.disp.corr < 0, 0, Cbl.disp.corr)) %>%
  group_by(PET.) %>%
  nest(.key='blooddata') %>%
  ungroup() %>% 
   mutate(input = map(blooddata, ~blood_interp(
             t_blood = .x$ABSS.sec/60, blood =.x$Cbl.disp.corr, 
             t_plasma=.x$ABSS.sec/60, plasma =.x$Cpl, 
             t_parentfrac = .x$ABSS.sec/60 , parentfrac= .x$parent_fract ) )) 

#Initially, I tried using inner_join instead of cbind. Did not work. Why, Granville? Also, the units for plasma concentration are in nCi/cc, is this a problem?

tacs <- tacs %>% 
  arrange(PET, Subjname, PETNo) %>% 
  bind_cols(blood)%>% 
  select(-PET.)


saveRDS(tacs, '../DerivedData/tacs.rds')

```

# Load data

```{r WB_delays}

tacs <- readRDS('../DerivedData/tacs.rds')

```

#Rearrangement of the Data into Long Format, creating 3 objects: tacs, AIF, Blood and parent fraction.

```{r tacs_long}

TAC <- tacs %>%
select(PET,tacdata, blooddata) %>% 
unnest(tacdata) %>% 
select(PET, Times, durations, WB, FC, THA, STR,CBL,TC) %>% 
group_by(PET) %>% 
  slice(-1) %>% 
  ungroup()

TAC <- TAC %>% 
  mutate(times = Times * 60) %>% 
  mutate(durations = durations * 60) %>% 
  mutate("start[seconds]" = times - (durations/2)) %>% 
  mutate("end[nCi/cc]" = times + (durations/2)) %>% 
  select(`start[seconds]`, `end[nCi/cc]`, WB:TC, PET) 
  
  

input <- tacs %>% 
  select(PET, blooddata) %>% 
  unnest(blooddata) %>% 
   select("sample-time[seconds]" = ABSS.sec, "plasma[kBq/cc]" = Cpl, PET) %>% 
  mutate("plasma[kBq/cc]" = round(unit_convert(`plasma[kBq/cc]`, "nCi", "kBq")))
 

blood <- tacs %>% 
  select(PET, blooddata) %>% 
  unnest(blooddata) %>% 
  select("sample-time[seconds]" = ABSS.sec, "whole-blood[kBq/cc]" = Cbl.disp.corr, PET) %>% 
  mutate("whole-blood[kBq/cc]" = round(unit_convert(`whole-blood[kBq/cc]`, "nCi", "kBq"))) 
 

parent_fraction <- tacs %>% 
  select(PET, blooddata) %>% 
  unnest(blooddata) %>% 
  select("time[seconds]" = ABSS.sec, "parent-fraction[1/1]" = parent_fract, PET) 
  
```

#Saving each individuals TAC inte seperate excel files according to PMOD

```{r}

#Group by and nest

TAC <- TAC %>% 
  mutate(PET = paste( PET, "tac", sep='_')) %>% 
  group_by(PET) %>% 
  nest(.key = tac)

#Create a named list with PET as the name and the nested data frames as content

TACs <- as.list(TAC$tac)
names(TACs) <- TAC$PET

#Create a new directory for the .csv files

dir.create("../PMOD_pk11195")

dir <- "../PMOD_pk11195"

#use purr with write_csv

TACs %>% 
  names(.) %>% 
  map(~ write_csv(TACs[[.]], file.path(dir, paste0(., ".csv")))) 


```

#Saving each individuals, AIF, whole blood data and parent fractions into seperate excel files according to the PMOD manual

```{r}

#Group by and nest

input <- input %>% 
  mutate(PET = paste( PET, "input", sep='_')) %>% 
  group_by(PET) %>% 
  nest(.key = aif)

blood <- blood %>% 
  mutate(PET = paste( PET, "wb", sep='_')) %>% 
  group_by(PET) %>% 
  nest(.key = wb)

parent_fraction <- parent_fraction %>% 
  mutate(PET = paste( PET, "parent_fract", sep='_')) %>% 
  group_by(PET) %>% 
  nest(.key = parent_fract)

#Create  named lists for easy "map" with purr. map2 did not work as easilly

Input <- as.list(input$aif)
names(Input) <- input$PET

whole_blood <- as.list(blood$wb)
names(whole_blood) <- blood$PET

pf <- as.list(parent_fraction$parent_fract)
names(pf) <- parent_fraction$PET

```

##save files

```{r}

Input %>% 
  names(.) %>% 
  map(~ write_csv(Input[[.]], file.path(dir, paste0(., ".csv")))) 

whole_blood %>% 
  names(.) %>% 
  map(~ write_csv(whole_blood[[.]], file.path(dir, paste0(., ".csv")))) 

pf %>% 
  names(.) %>% 
  map(~ write_csv(pf[[.]], file.path(dir, paste0(., ".csv")))) 

```

#Creating .txt files

```{r}

oldwd <- getwd()

dir.create("../txt_PMOD_pk11195")

txt_dir <- "../txt_PMOD_pk11195"

setwd(txt_dir)

map2(.x = TAC$tac, .y = TAC$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, row.names = F))

map2(.x = input$aif, .y = input$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, row.names = F))

map2(.x = blood$wb, .y = blood$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, row.names = F))

map2(.x = parent_fraction$parent_fract, .y = parent_fraction$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, row.names = F))

setwd(oldwd)

```

Note: got some strange message "[[1]]NULL" when generating the text files, but the files themselves look fine

#Creating tab delimited files

```{r}

oldwd <- getwd()

dir.create("../tab_delim_PMOD_pk11195")

tab_dir <- "../tab_delim_PMOD_pk11195"

setwd(tab_dir)

map2(.x = TAC$tac, .y = TAC$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, sep="\t", row.names = F))

map2(.x = input$aif, .y = input$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, sep="\t", row.names = F))

map2(.x = blood$wb, .y = blood$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, sep="\t", row.names = F))

map2(.x = parent_fraction$parent_fract, .y = parent_fraction$PET, .f = ~ write.table(x = .x, file = paste0(.y, ".txt") , quote = FALSE, sep="\t", row.names = F))

setwd(oldwd)

```
